
# 사용자-기관 AI 기관 추천

## 흐름
1. [초기화] 등록된 기관의 임베딩 사전 저장
   - 기관 정보 -> 텍스트 변환  -> bge-m3 -> pgvector 저장
   - 인덱스 최적화 시키기

2. [업데이트] 등록시 동기 생성, 수정시이에는 비동기 배치 업데이트 실시
   - 등록 수정 시에 업데이트
   - 배치 작업 : 매일 자정 또는 정해진 시간에 1시간 마다 플래그된 기관만 임베딩 재생성
   - 새 임베딩 생성 후 원자적 교체 진행

3. [요청] Spring으로부터 MemberId, ElderlyProfileId, text(추가 입력 받은 텍스트)를 전달 받는다.
   - 파라미터: memberId, elderlyProdileId, test(추가 텍스트)

4. [조회] 사용자 MemberId로부터 DB에서 사용자 데이터를 조회한다.
   - memberId로 member 조회
   - elderlyProfileId로 ElderlyProdile 조회
   - 캐싱: Redis에 5분간 캐시 저장

5. [생성] Member + ElderlyProfile + text 를 통해서 기관의 임베딩과 동일한 공간에 위치하도록 텍스트를 생성한다.
   - Member + ElderlyProdile + text 결합 텍스트 생성
   - 기관의 텍스트와 비슷한 템플릿으로 변환

6. [임베딩] 생성한 텍스트를 임베딩 데이터로 변환한다.
   - bge-m3 사용하여 임베딩으로 변환
   - 3회 정도 시도하고, 실패시 5xx 반환한다.

7. [검색]사용자의 임베딩 1개와 기관(10,000개라고 가정) 임베딩 유사도 계산 후 상위 5개 기관 추출 및 유사도로 정렬
   - 연산 전에 사전 필터링: 서비스 타입 등 최소한의 필터링 적용 
   - cosign similarity 연산으로 상위 5개 기관 조회한다.
   - 인덱스 활용하여 시간 단축 목표

8. [분석] 상위 5개를 다시 구, 어구 단위로 사용자와 어떤 부분의 키워드에서 비슷했는지 계산
   - 매칭 추천의 이유 키워드 추출 LLM으로 실시간 키워드 생성
   - 각 기관당 핵심 키워드 3개

9. [응답] 추천된 3개의 각 기관마다 (기관 Id, 추천의 이유가된 키워드(3개라고 가정))를 리스트로 반환한다.
   - 응답 형식 
   ```
      [
         {
            institutionId = 1,
            matchScore = 90,
            keywords = [
               "친절",
               "청결",
               "치매 전문"
            ]
         }
      ]
   ```
   - 추천의 결과 db 저장 
   - 응답 시간을 목표로 얼마나 잡을까 ?

## 기능 목록
1. 등록된 기관의 임베딩 데이터 저장 기능
   - 기관 정보 -> 정해진 텍스트 형식으로 변환
   - bge-m3 모델 저장
   - pgvector에 저장 과 인덱스 생성

---
2. 임베딩 배치 업데이트 기능
: 배치에 따라 요청된 정보다 수정된 기관의 임베딩 데이터 업데이트 후 재 저장 기능
   - 스케줄러 사용
   - 주기: 매일 자정 등 일정한 시간
   - dirty flag 확인 후 변경된 기관만 재 생성

---
3. 추천 API 기능
: Spring으로부터 MemberId, ElderlyProdileId, text를 이력받아 계산 후 해당 값을 return 하는 controller
   - POST `/api/v1/reccomendations`
   - 요청: `{memberId, elderlyProfileId, additionalText}`
   - 응답: `{institutions: [{id, score, reasons}]}`

---
4. 사용자 데이터 조회 기능
: memberId로 DB에서 사용자 조회하는 기능
   - 캐싱: Redis (TTL: 5분)
   - 에러 처리 : 사용자 NotFound

---
5. 사용자 텍스트 생성 유틸 기능
   - 조회된 사용자와 어르신 데이터를 통해 텍스트 생성 유틸 기능
   - 사용자(어르신)와 기관 둘 다 같은 관점(건강 상태, 인지, 활동, 서비스 유형, 지역, 시간대 등)으로 풀어쓴 텍스트를 만들어서 bge-m3에 넣어야 한다.
   - 어르신 프로필
   ```
      [어르신 프로필]
      - 기본 정보:
         - 연령: 만 82세
         - 성별: 여성

      - 건강 및 기능 상태:
         - 활동 수준: 
            - HIGH: "혼자 외출 가능하고 일상생활 대부분 스스로 가능"
            - MID: "실내 활동 위주, 짧은 거리 보행 가능"
            - LOW: "거동이 많이 불편하고 이동 시 도움 필요"
            - BEDRIDDEN: "침대에서만 생활"
         - 인지 수준: 치매 초기로 가끔 기억력 저하와 길 잃음이 있습니다.
            - NORMAL: "인지 기능에 큰 문제 없음"
            - MILD_COGNITIVE_IMPAIRMENT: "경미한 기억력 저하가 있습니다."
            - MILD_DEMENTIA: "일상생활에 약간의 지장가는 수준입니다."
            - MODERATE_DEMENTIA: "치매 초기, 가끔 기억력 저하와 길 잃습니다."
            - SEVERE_DEMENTIA: "인지 저하가 심하고 지속적인 보호가 필요합니다."
         - 장기 요양 등급: 장기 요양 2등급

      - 선호 태그:
         - 전문 질환: "치매", "당뇨"
         - 서비스 유형: "주간 보호", "장기 요양"
         - 운영 특성: "치매 전담", "24시간 간호사"
         - 환경 시설: "정원", "예배실"
         - 리뷰 유형: "친절한 직원"

      - 추가 텍스트:  "저희 어머니가 사람 많은 곳을 힘들어 하세요"
   ```

   - 기관
   ```
      - 기본 정보:
         - 기관명: 사랑재 요양원
         - 기관 유형: 요양원
         - 서울시 송파구 인근
      - 운영 및 이용 정보:
         - 운영 시간: 평일 08:00~20:00 토요일 09:00~15:00
      - 기관 태그:
         - 전문 질환: "치매", "당뇨"
         - 서비스 유형: "주간 보호", "장기 요양"
         - 운영 특성: "치매 전담", "24시간 간호사"
         - 환경 시설: "정원", "예배실"
         - 리뷰 유형: "친절한 직원"
      - 기관 설명 텍스트: "치매 교육을 받은 요양보호사가 다수 근무하며 매우 친절을 강조하는 기관입니다. 
                        기독교 요양원으로서 예배실이 구비가 되어 있어요."
   ```

---
6. 텍스트에서 임베딩 변환 기능
   - bge-m3 모델을 사용하여 텍스트를 임베딩으로 변환한다.
   - 재시도 로직을 통해 3회 재시도 후 실패를 반환한다.
   - 타임 아웃은 10초로 설정한다.

---
7. 사전 최소한의 비즈니스 로직 필터링
   - 제외할 조건: 입수 가능한 기관,
   - 선호 기관 유형 필터링

---
8. pgvector 코사인 유사도 계산 및 정렬 기능

---
9. 매칭 키워드 추출 기능 1:1 기관과 사용자 사이의 어떤 부분의 키워드가 비슷한지 LLM에게 요청을 보내 키워드 3개 추출한다.
